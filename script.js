
const mesaData = {
    "Pacha": {
        1:{nombres:["pacha sunset", ""], montos:["980", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["23-01-2026", ""], horas:["10:20", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["930", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["20-01-2026", ""], horas:["12:05", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["1200", ""], tragos:["parrales"], combo:"pachamama", fechas:["22-01-2026", ""], horas:["15:00", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]},
        4:{nombres:["pacha sunset", ""], montos:["700", ""], tragos:["Jager"], combo:"Jager", fechas:["23-01-2026", ""], horas:["12:00", ""], operaciones:["4", ""], cuentas:["20151595559307", ""]},
        5:{nombres:["pacha sunset", ""], montos:["700", ""], tragos:["parrales,FD5"], combo:"cascabel", fechas:["24-01-2026", ""], horas:["17:33", ""], operaciones:["5", ""], cuentas:["20151595559307", ""]},
        6:{nombres:["pacha sunset", ""], montos:["750", ""], tragos:["parrales,FD5"], combo:"cascabel", fechas:["22-01-2026", ""], horas:["19:28", ""], operaciones:["6", ""], cuentas:["20151595559307", ""]},
        7:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["7", ""], cuentas:["20151595559307", ""]},
        8:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["8", ""], cuentas:["20151595559307", ""]},
        9:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["9", ""], cuentas:["20151595559307", ""]},
        10:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["10", ""], cuentas:["20151595559307", ""]}
    },

    "Lounge": {
        1:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]},
        4:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["4", ""], cuentas:["20151595559307", ""]},
        5:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["5", ""], cuentas:["20151595559307", ""]},
        6:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["6", ""], cuentas:["20151595559307", ""]},
        7:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["7", ""], cuentas:["20151595559307", ""]},
        8:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["8", ""], cuentas:["20151595559307", ""]},
        9:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["9", ""], cuentas:["20151595559307", ""]},
        10:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["10", ""], cuentas:["20151595559307", ""]},
        11:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["11", ""], cuentas:["20151595559307", ""]}
    },

    "Cholet": {
        1:{nombres:["pacha sunset", ""], montos:["980", ""], tragos:["parrales,Gin Amazonico"], combo:"cumplea√±ero", fechas:["23-01-2026", ""], horas:["12:00", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["700", ""], tragos:["Jager"], combo:"Jager", fechas:["24-01-2026", ""], horas:["12:52", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]},
        4:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["4", ""], cuentas:["20151595559307", ""]},
        5:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["5", ""], cuentas:["20151595559307", ""]},
        6:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["6", ""], cuentas:["20151595559307", ""]},
        7:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["7", ""], cuentas:["20151595559307", ""]},
        8:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["8", ""], cuentas:["20151595559307", ""]},
        9:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["9", ""], cuentas:["20151595559307", ""]},
        10:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["10", ""], cuentas:["20151595559307", ""]},
        11:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["11", ""], cuentas:["20151595559307", ""]},
        12:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["22", ""], cuentas:["20151595559307", ""]}
    },

    "Parrales": {
        1:{nombres:["pacha sunset", ""], montos:["500", ""], tragos:["parrales"], combo:"banx", fechas:["23-01-2026", ""], horas:["16:14", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["880", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["23-01-2026", ""], horas:["00:07", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["500", ""], tragos:["parrales"], combo:"banx", fechas:["23-01-2026", ""], horas:["11:05", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]},
        4:{nombres:["pacha sunset", ""], montos:["980", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["23-01-2026", ""], horas:["13:14", ""], operaciones:["4", ""], cuentas:["20151595559307", ""]},
        5:{nombres:["pacha sunset", ""], montos:["980", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["19-01-2026", ""], horas:["09:50", ""], operaciones:["5", ""], cuentas:["20151595559307", ""]},
        6:{nombres:["pacha sunset", ""], montos:["500", ""], tragos:["parrales"], combo:"banx", fechas:["24-01-2026", ""], horas:["07:49", ""], operaciones:["6", ""], cuentas:["20151595559307", ""]},
        7:{nombres:["pacha sunset", ""], montos:["1300", ""], tragos:["parrales"], combo:"pachamama", fechas:["20-01-2026", ""], horas:["12:00", ""], operaciones:["7", ""], cuentas:["20151595559307", ""]},
        8:{nombres:["pacha sunset", ""], montos:["500", ""], tragos:["parrales"], combo:"banx", fechas:["23-01-2026", ""], horas:["13:02", ""], operaciones:["8", ""], cuentas:["20151595559307", ""]},
        9:{nombres:["pacha sunset", ""], montos:["500", ""], tragos:["parrales"], combo:"banx", fechas:["22-01-2026", ""], horas:["04:33", ""], operaciones:["9", ""], cuentas:["20151595559307", ""]},
        10:{nombres:["pacha sunset", ""], montos:["980", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["21-01-2026", ""], horas:["18:57", ""], operaciones:["10", ""], cuentas:["20151595559307", ""]},
        11:{nombres:["pacha sunset", ""], montos:["980", ""], tragos:["parrales,FD5"], combo:"cumplea√±ero", fechas:["23-01-2026", ""], horas:["19:22", ""], operaciones:["11", ""], cuentas:["20151595559307", ""]},
        12:{nombres:["pacha sunset", ""], montos:["1300", ""], tragos:["parrales"], combo:"pachamama", fechas:["22-01-2026", ""], horas:["22:14", ""], operaciones:["12", ""], cuentas:["20151595559307", ""]},
        13:{nombres:["MAMA", ""], montos:["900", ""], tragos:["parrales"], combo:"pachamama", fechas:["23-01-2026", ""], horas:["12:00", ""], operaciones:["13", ""], cuentas:["201522092966343", ""]},
        14:{nombres:["pacha sunset", ""], montos:["930", ""], tragos:["parrales,Viuda"], combo:"cumplea√±ero", fechas:["19-01-2026", ""], horas:["14:33", ""], operaciones:["14", ""], cuentas:["20151595559307", ""]},
        15:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["15", ""], cuentas:["20151595559307", ""]},
        16:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["16", ""], cuentas:["20151595559307", ""]},
        17:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["17", ""], cuentas:["20151595559307", ""]},
        18:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["18", ""], cuentas:["20151595559307", ""]}
    },

    "VIP": {
        1:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]},
        4:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["4", ""], cuentas:["20151595559307", ""]},
        5:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["5", ""], cuentas:["20151595559307", ""]},
        6:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["6", ""], cuentas:["20151595559307", ""]}
    },

    "Extra": {
        1:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]},
        4:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["4", ""], cuentas:["20151595559307", ""]},
        5:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["5", ""], cuentas:["20151595559307", ""]},
        6:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["6", ""], cuentas:["20151595559307", ""]},
        7:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["7", ""], cuentas:["20151595559307", ""]},
        8:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["8", ""], cuentas:["20151595559307", ""]},
        9:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["9", ""], cuentas:["20151595559307", ""]},
        10:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["10", ""], cuentas:["20151595559307", ""]}
    },

    "Camel": {
        1:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["1", ""], cuentas:["20151595559307", ""]},
        2:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["2", ""], cuentas:["20151595559307", ""]},
        3:{nombres:["pacha sunset", ""], montos:["", ""], tragos:["parrales"], combo:"", fechas:["01-2026", ""], horas:["", ""], operaciones:["3", ""], cuentas:["20151595559307", ""]}
    }
};
document.addEventListener('DOMContentLoaded', () => {
    // ... (Tu c√≥digo existente para el sidebar) ...
    const sidebar = document.getElementById('sidebar');
    const menuIcon = document.getElementById('menu-icon');
    const closeBtn = document.querySelector('.sidebar .close-btn');
    const overlay = document.getElementById('overlay');

    const mostrarComprobante = (areaName, mesaNumber) => {
        const datosMesa = mesaData[areaName][mesaNumber];
        if (!datosMesa) return;

        // Verificar si la mesa est√° libre: NO hay hora registrada
        const transaccionesConHora = datosMesa.horas.filter(h => h && h.trim() !== '').length;
        const mesaLibre = transaccionesConHora === 0;


        // Crear modal
        const modal = document.createElement('div');
        modal.classList.add('comprobante-modal');

        if (mesaLibre) {
            // Mesa Libre
            modal.innerHTML = `
                <div class="comprobante-content mesa-libre">
                    <h2>${areaName} ${mesaNumber} LIBRE</h2>
                </div>
            `;
        } else {
            // C√°lculo del total
            const monto1 = parseFloat(datosMesa.montos[0]) || 0;
            const monto2 = parseFloat(datosMesa.montos[1]) || 0;
            const totalMesa = (monto1 + monto2).toFixed(2);

            const buildTransactionDetail = (index) => {
                const nombre = datosMesa.nombres[index];
                const monto = datosMesa.montos[index];
                const fecha = datosMesa.fechas[index];
                const hora = datosMesa.horas[index];
                const operacion = datosMesa.operaciones[index];
                const cuenta = datosMesa.cuentas[index];

                if (!nombre && !monto && !fecha && !hora && !operacion && !cuenta) return '';

                const tragoComboHTML = index === 0 ? `
                    <div class="detail-row">
                        <span>Trago:</span>
                        <span class="value">${datosMesa.tragos.join(', ') || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span>Combo:</span>
                        <span class="value">${datosMesa.combo || 'N/A'}</span>
                    </div>
                ` : '';

                return `
                    <div class="transaction-block">
                        <h4>Transacci√≥n #${index + 1}</h4>
                        <div class="detail-row"><span>Cuenta Destino:</span><span class="value">${nombre || 'N/A'}</span></div>
                        <div class="detail-row"><span>Monto:</span><span class="value monto">${monto ? 'Bs. ' + monto : 'N/A'}</span></div>
                        <div class="detail-row"><span>Fecha y Hora:</span><span class="value">${fecha || 'N/A'} ${hora || 'N/A'}</span></div>
                        <div class="detail-row"><span>N¬∞ de Operaci√≥n:</span><span class="value">${operacion || 'N/A'}</span></div>
                        <div class="detail-row"><span>N¬∞ de Cuenta:</span><span class="value">${cuenta || 'N/A'}</span></div>
                        ${tragoComboHTML}
                        <div class="divider"></div>
                    </div>
                `;
            };

            modal.innerHTML = `
                <div class="comprobante-content">
                    <div class="comprobante-header">
                        <h2>Comprobante de Ingreso</h2>
                        <p><strong>√Årea:</strong> ${areaName} | <strong>Mesa:</strong> ${mesaNumber}</p>
                        <button class="close-comprobante">&times;</button>
                    </div>

                    <div class="comprobante-body">
                        ${buildTransactionDetail(0)}
                        ${buildTransactionDetail(1)}
                    </div>

                    <div class="total-container">
                        <div class="total-row">
                            <span>TOTAL FACTURADO:</span>
                            <span class="total-value">Bs. ${totalMesa}</span>
                        </div>
                    </div>

                    <p class="nota">Estos datos son referenciales a las transacciones registradas en la mesa.</p>
                </div>
            `;

            // Si solo hay 1 transacci√≥n con hora, hacer modal m√°s estrecho
            if (transaccionesConHora === 1) {
                modal.querySelector('.comprobante-content').classList.add('single-transaction-modal');
            }

        }

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Cerrar con bot√≥n
        const closeBtn = modal.querySelector('.close-comprobante');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                modal.remove();
                document.body.style.overflow = '';
            });
        }

        // Cerrar clic fuera
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        });
    };


    const openMenu = () => {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    };

    const closeMenu = () => {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
    };

    if (menuIcon) {
        menuIcon.addEventListener('click', openMenu);
    }
    if (closeBtn) {
        closeBtn.addEventListener('click', closeMenu);
    }
    if (overlay) {
        overlay.addEventListener('click', closeMenu);
    }
    document.querySelectorAll('.sidebar a').forEach(link => {
        link.addEventListener('click', closeMenu);
    });

    const btnInventarios = document.querySelector('a[href="#area-cholet"]');

    if (btnInventarios) {
        btnInventarios.addEventListener('click', (e) => {
            e.preventDefault();
            closeMenu(); // Cierra el men√∫ lateral
            const resumen = calcularResumenInventario(mesaData); // Llama a la nueva funci√≥n
            mostrarModalInventario(resumen); // Muestra el nuevo modal
        });
    }
    const btnPorcentajes = document.querySelector('a[href="#area-lounge"]');

    if (btnPorcentajes) {
        btnPorcentajes.addEventListener('click', (e) => {
            e.preventDefault();
            closeMenu(); // Cierra el men√∫ lateral
            const resumen = calcularResumenOcupacion(mesaData);
            mostrarModalOcupacion(resumen);
        });
    }


    /* =====================================================
      FUNCI√ìN PARA CALCULAR EL RESUMEN DE INVENTARIO (TRAGOS/COMBOS)
      ===================================================== */
    const calcularResumenInventario = (data) => {
        const resumen = {
            tragos: {},
            combos: {}
        };

        for (const area in data) {
            for (const mesa in data[area]) {
                const datosMesa = data[area][mesa];

                // ===== VALIDACIONES =====
                const monto = datosMesa.montos?.[0];
                const fecha = datosMesa.fechas?.[0];

                const montoValido = monto !== "" && !isNaN(monto) && Number(monto) > 0;
                const fechaValida = fecha !== "" && fecha !== "12-25"; // ajusta si deseas otro filtro

                // ‚ùå Si no hay venta real, NO contar inventario
                if (!montoValido || !fechaValida) continue;

                // ===== TRAGOS =====
                const tragosStr = datosMesa.tragos?.[0];
                if (tragosStr) {
                    const tragosArray = tragosStr
                        .split(',')
                        .map(t => t.trim().toUpperCase())
                        .filter(Boolean);

                    tragosArray.forEach(trago => {
                        resumen.tragos[trago] = (resumen.tragos[trago] || 0) + 1;
                    });
                }

                // ===== COMBOS =====
                const comboStr = datosMesa.combo;
                if (comboStr) {
                    const comboKey = comboStr.trim().toUpperCase();
                    if (comboKey) {
                        resumen.combos[comboKey] = (resumen.combos[comboKey] || 0) + 1;
                    }
                }
            }
        }

        return resumen;
    };

    /* =====================================================
      FUNCI√ìN PARA MOSTRAR EL MODAL DE INVENTARIO
      ===================================================== */
    const mostrarModalInventario = (resumen) => {
        const modal = document.createElement('div');
        modal.classList.add('resumen-modal'); // Reutilizamos la clase principal del modal

        // --- Generar HTML de Tragos ---
        let tragosHTML = '';
        const tragosOrdenados = Object.entries(resumen.tragos).sort(([, a], [, b]) => b - a);
        const separador = '<div class="comanda-separator">-----------------------------------------</div>';
        if (tragosOrdenados.length > 0) {
            tragosHTML = tragosOrdenados.map(([nombre, cantidad]) => `
                <li class="inventario-item">
                    <span class="item-nombre">${nombre}</span>
                    <span class="item-cantidad">${cantidad} unidades</span>
                </li>
            `).join('');
        } else {
            tragosHTML = '<p class="sin-registros">No se registraron tragos.</p>';
        }

        // --- Generar HTML de Combos ---
        let combosHTML = '';
        const combosOrdenados = Object.entries(resumen.combos).sort(([, a], [, b]) => b - a);

        if (combosOrdenados.length > 0) {
            combosHTML = combosOrdenados.map(([nombre, cantidad]) => `
                <li class="inventario-item">
                    <span class="item-nombre">${nombre}</span>
                    <span class="item-cantidad">${cantidad} veces</span>
                </li>
            `).join('');
        } else {
            combosHTML = '<p class="sin-registros">No se registraron combos.</p>';
        }

        // --- Estructura Final del Modal ---
        modal.innerHTML = `
            <div class="resumen-content inventario-content">
                <div class="resumen-header">
                    <h2>üìã Inventario</h2>
                    <button class="close-resumen">&times;</button>
                </div>

                <div class="resumen-body">

                    <h3 class="inventario-titulo">*** TRAGOS POR UNIDAD ***</h3>
                    ${separador}
                    <ul class="inventario-lista">
                        ${tragosHTML}
                    </ul>
                    ${separador}

                    <h3 class="inventario-titulo">*** COMBOS VENDIDOS ***</h3>
                    ${separador}
                    <ul class="inventario-lista">
                        ${combosHTML}
                    </ul>
                    ${separador}

                </div>

                <p class="nota">Conteo de insumos basado en mesas.</p>
            </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden'; // Bloquear scroll del fondo

        // L√≥gica para cerrar
        modal.querySelector('.close-resumen').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto'; // Restaurar scroll
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto'; // Restaurar scroll
            }
        });
    };
    /* =====================================================
        FUNCI√ìN PRINCIPAL: GENERAR RESUMEN GENERAL
        (CON TRANSFERENCIAS 50% PARA COMBO "PACHAMAMA")
    ===================================================== */
    const generarResumenGeneral = (data) => {
        let totalGlobal = 0;

        // Acumular ingresos por nombre
        const resumenPorNombre = {};

        // Acumuladores especiales para transferencias
        let totalTransferenciasMama = 0; // PACHA ‚Üí MAMA
        let totalTransferenciasPacha = 0; // MAMA ‚Üí PACHA
        const detalleTransferenciasMama = [];
        const detalleTransferenciasPacha = [];

        for (const area in data) {
            for (const mesa in data[area]) {
                const datosMesa = data[area][mesa];

                // Revisar si la mesa tiene combo PACHAMAMA
                const combo = datosMesa.combo ? datosMesa.combo.toLowerCase() : "";

                for (let i = 0; i < 2; i++) {
                    const nombre = datosMesa.nombres[i].trim().toUpperCase();
                    const montoStr = datosMesa.montos[i];
                    const monto = parseFloat(montoStr) || 0;

                    if (monto > 0) {
                        // Suma al total global
                        totalGlobal += monto;

                        // Registrar por cuenta destino
                        const clave = nombre || "SIN NOMBRE ASIGNADO";

                        if (resumenPorNombre[clave]) {
                            resumenPorNombre[clave].monto += monto;
                            resumenPorNombre[clave].transacciones.push({
                                area: area,
                                mesa: mesa,
                                monto: monto.toFixed(2),
                                fecha: datosMesa.fechas[i],
                                operacion: datosMesa.operaciones[i]
                            });
                        } else {
                            resumenPorNombre[clave] = {
                                monto: monto,
                                transacciones: [{
                                    area: area,
                                    mesa: mesa,
                                    monto: monto.toFixed(2),
                                    fecha: datosMesa.fechas[i],
                                    operacion: datosMesa.operaciones[i]
                                }]
                            };
                        }

                        // =====================================================
                        // TRANSFERENCIA DEL 50% PARA COMBO PACHAMAMA
                        // =====================================================
                        if (combo === "pachamama") {
                            if (nombre === "PACHA SUNSET") {
                                const porcentaje = monto * 0.50;
                                totalTransferenciasMama += porcentaje;
                                detalleTransferenciasMama.push({
                                    area: area,
                                    mesa: mesa,
                                    montoOriginal: monto,
                                    transferencia: porcentaje
                                });
                            } else if (nombre === "MAMA") {
                                const porcentaje = monto * 0.50;
                                totalTransferenciasPacha += porcentaje;
                                detalleTransferenciasPacha.push({
                                    area: area,
                                    mesa: mesa,
                                    montoOriginal: monto,
                                    transferencia: porcentaje
                                });
                            }
                        }
                    }
                }
            }
        }

        return {
            totalGlobal: totalGlobal.toFixed(2),
            porNombre: resumenPorNombre,
            mamaTransferencia: totalTransferenciasMama,
            mamaDetalle: detalleTransferenciasMama,
            pachaTransferencia: totalTransferenciasPacha,
            pachaDetalle: detalleTransferenciasPacha
        };
    };

    /* =====================================================
        MOSTRAR EL MODAL COMPLETO CON RESUMEN + TRANSFERENCIAS + SALDO NETO PACHA
    ===================================================== */
    const mostrarModalResumen = (resumen) => {
        const modal = document.createElement('div');
        modal.classList.add('resumen-modal');

        // Total global sin decimales
        const totalGlobalSinDecimales = Math.trunc(parseFloat(resumen.totalGlobal)).toLocaleString('es-BO');

        // Ordenar cuentas por monto
        let detalleHTML = '';
        const nombresOrdenados = Object.keys(resumen.porNombre)
            .map(nombre => ({ nombre, datos: resumen.porNombre[nombre] }))
            .sort((a, b) => b.datos.monto - a.datos.monto);

        nombresOrdenados.forEach(item => {
            const { nombre, datos } = item;

            let transaccionesDetalle = datos.transacciones.map(t => {
                const montoIndividualSin = Math.trunc(parseFloat(t.monto)).toLocaleString('es-BO');
                return `
                    <li class="tx-item">
                        <span class="tx-mesa">${t.area} ${t.mesa}</span>
                        <span class="tx-monto">Bs. ${montoIndividualSin}</span>
                    </li>
                `;
            }).join('');



            detalleHTML += `
                <div class="resumen-bloque-cuenta">
                    <div class="resumen-cuenta-header">
                        <h4>Cuenta: ${nombre} (${datos.transacciones.length} transacciones)</h4>
                        <span class="monto-total-cuenta">Total: Bs. ${datos.monto.toFixed(2)}</span>
                    </div>
                   <ul class="resumen-lista-tx grid-3">
                       ${transaccionesDetalle}
                   </ul>

                </div>
            `;
        });

        /* =====================================================
           BLOQUE DE TRANSFERENCIAS DETALLADAS
        ===================================================== */
        let mamaHTML = "";
        if (resumen.mamaTransferencia > 0) {
            const totalMamaRedondeado = Math.trunc(resumen.mamaTransferencia).toLocaleString('es-BO');

            const listaMama = resumen.mamaDetalle.map(d => `
                <li class="resumen-transaccion" style="display:flex; justify-content:space-between; padding:4px 8px; border-bottom:1px solid #ccc;">
                    <span>${d.area} ${d.mesa} (50% de ${d.montoOriginal}) Bs</span>
                    <span style="color:#000; font-weight:600;">Bs. ${Math.trunc(d.transferencia)}</span>
                </li>
            `).join('');

            mamaHTML = `
                <div class="resumen-bloque-cuenta" style="border-top:2px solid #c0392b; margin-top:15px;">
                    <div class="resumen-cuenta-header">
                        <h4>Transferencias a MAMA (50% del combo Pachamama)</h4>
                        <span class="monto-total-cuenta">Total a transferir: Bs. ${totalMamaRedondeado}</span>
                    </div>
                    <ul class="resumen-lista-tx">
                        ${listaMama}
                    </ul>
                </div>
            `;
        }

        let pachaHTML = "";
        if (resumen.pachaTransferencia > 0) {
            const totalPachaRedondeado = Math.trunc(resumen.pachaTransferencia).toLocaleString('es-BO');

            const listaPacha = resumen.pachaDetalle.map(d => `
                <li class="resumen-transaccion" style="display:flex; justify-content:space-between; padding:4px 8px; border-bottom:1px solid #ccc;">
                    <span>[${d.area} M-${d.mesa}] 50% de ${d.montoOriginal} Bs</span>
                    <span style="color:#000; font-weight:600;">Bs. ${Math.trunc(d.transferencia)}</span>
                </li>
            `).join('');

            pachaHTML = `
                <div class="resumen-bloque-cuenta" style="border-top:2px solid #2980b9; margin-top:15px;">
                    <div class="resumen-cuenta-header">
                        <h4>Transferencias a PACHA SUNSET (50% del combo Pachamama)</h4>
                        <span class="monto-total-cuenta">Total a transferir: Bs. ${totalPachaRedondeado}</span>
                    </div>
                    <ul class="resumen-lista-tx">
                        ${listaPacha}
                    </ul>
                </div>
            `;
        }


        /* =====================================================
           BLOQUE DE SALDO NETO DE PACHA SUNSET (DETALLADO)
        ===================================================== */
        let saldoHTML = '';

        const totalPachaIngresado = resumen.porNombre["PACHA SUNSET"]
            ? resumen.porNombre["PACHA SUNSET"].monto
            : 0;

        // Transferencias del combo Pachamama
        const transferenciasPachaAMama = resumen.mamaTransferencia || 0;   // PACHA ‚Üí MAMA
        const transferenciasMamaAPacha = resumen.pachaTransferencia || 0;  // MAMA ‚Üí PACHA

        // C√°lculo del saldo REAL
        const saldoPacha =
            totalPachaIngresado
            - transferenciasPachaAMama
            + transferenciasMamaAPacha;

        if (totalPachaIngresado > 0) {

            saldoHTML += `
                <!-- L√≠nea divisoria -->
                <hr style="border:2px solid #39ff14; margin-top:20px; margin-bottom:10px;">

                <h3 style="text-align:center; color:#c7c7c7; margin-bottom:10px;">
                    Cuenta PACHA SUNSET ‚Äî Detalle del saldo actual
                </h3>

                <div class="resumen-bloque-cuenta" style="
                    width:320px;
                    margin:0 auto 20px auto;
                    padding:15px;
                    background:#fff;
                    color:#000;
                    font-family:monospace;
                    border-radius:8px;
                    box-shadow:0 0 5px rgba(0,0,0,0.2);
                ">

                    <p><strong>Total ingresado por ventas de mesas:</strong><br>
                        Bs. ${Math.trunc(totalPachaIngresado)}
                    </p>

                    <p><strong>(‚àí) Transferencias realizadas a MAMA:</strong><br>
                        Bs. ${Math.trunc(transferenciasPachaAMama)}
                    </p>

                    <p><strong>(+) Transferencias recibidas desde MAMA:</strong><br>
                        Bs. ${Math.trunc(transferenciasMamaAPacha)}
                    </p>

                    <hr style="border:1px dashed #000; margin:12px 0;">

                    <p style="font-size:14px;">
                        <strong>C√°lculo:</strong><br>
                        ${Math.trunc(totalPachaIngresado)}
                        ‚àí ${Math.trunc(transferenciasPachaAMama)}
                        + ${Math.trunc(transferenciasMamaAPacha)}
                    </p>

                    <hr style="border:1px solid #000; margin:12px 0;">

                    <p style="text-align:center;">
                        <strong>SALDO ACTUAL REAL:</strong><br>
                        <span style="color:blue; font-size:18px;">
                            Bs. ${Math.trunc(saldoPacha)}
                        </span>
                    </p>

                    <hr style="border:1px dashed #000; margin:15px 0;">

                    <p><strong>Banco:</strong> BCP</p>
                    <p><strong>N√∫mero de cuenta:</strong>
                        <span style="color:blue;">20151595559307</span>
                    </p>
                    <p><strong>Referencia:</strong> Ventas de mesas</p>

                </div>
            `;
        }



        // Modal final
        modal.innerHTML = `
            <div class="resumen-content">
                <div class="resumen-header">
                    <h2>Resumen Global de Ingresos</h2>
                    <button class="close-resumen">&times;</button>
                </div>

                <div class="resumen-body">
                    <h3>Detalle de Ingresos por Cuenta Destino:</h3>
                    ${detalleHTML}
                </div>

                <div class="resumen-total-bar">
                    <span>TOTAL INGRESADO:</span>
                    <span class="total-final">Bs. ${totalGlobalSinDecimales}</span>
                </div>

                <!-- L√≠nea divisoria verde ne√≥n -->
                <hr style="border:2px solid #39ff14; margin-top:20px; margin-bottom:10px;">

                <!-- T√≠tulo centrado -->
                <h3 style="text-align:center; color:#f0f2f5; margin-bottom:15px;">Transferencias 50% de combos Pachamama</h3>

                <!-- Bloques de transferencias -->
                ${mamaHTML}
                ${pachaHTML}

                <!-- Bloque de saldo neto PACHA -->
                ${saldoHTML}

                <p class="nota">Datos generados autom√°ticamente.</p>
            </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        modal.querySelector('.close-resumen').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.style.overflow = '';
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                document.body.style.overflow = '';
            }
        });
    };




    // ----------------------------------------------------
    // A√±adir el listener al final de tu DOMContentLoaded
    // ----------------------------------------------------
    const btnResumen = document.getElementById('mostrar-resumen');

    if (btnResumen) {
    btnResumen.addEventListener('click', (e) => {
    e.preventDefault(); // Evita que la p√°gina salte al inicio
    closeMenu(); ¬† ¬† ¬†// Cierra el men√∫ lateral
    const resumen = generarResumenGeneral(mesaData);
    mostrarModalResumen(resumen);
    });
    }
        /* =====================================================
        FUNCI√ìN PARA CALCULAR EL RESUMEN DE OCUPACI√ìN
        ===================================================== */

        const calcularResumenOcupacion = (data) => {
            let totalMesas = 0;
            let mesasOcupadas = 0;
            const resumenPorArea = {};

            // 1. Recorrer todas las √°reas en los datos de las mesas
            for (const area in data) {
                let mesasArea = 0;
                let ocupadasArea = 0;

                // 2. Contar mesas y ocupadas por cada √°rea
                for (const mesa in data[area]) {
                    mesasArea++;
                    const datosMesa = data[area][mesa];

                    // Consideramos la mesa "ocupada" si al menos una transacci√≥n tiene un monto > 0
                    const monto1 = parseFloat(datosMesa.montos[0]) || 0;
                    const monto2 = parseFloat(datosMesa.montos[1]) || 0;

                    if (monto1 > 0 || monto2 > 0) {
                        ocupadasArea++;
                    }
                }

                // Acumular al total global
                totalMesas += mesasArea;
                mesasOcupadas += ocupadasArea;

                // Guardar el resumen por √°rea
                resumenPorArea[area] = {
                    total: mesasArea,
                    ocupadas: ocupadasArea,
                    porcentaje: (mesasArea > 0) ? ((ocupadasArea / mesasArea) * 100).toFixed(1) : 0
                };
            }

            // Calcular el total general
            const porcentajeGlobal = (totalMesas > 0) ? ((mesasOcupadas / totalMesas) * 100).toFixed(1) : 0;

            return {
                totalMesas: totalMesas,
                mesasOcupadas: mesasOcupadas,
                mesasDisponibles: totalMesas - mesasOcupadas,
                porcentajeGlobal: porcentajeGlobal,
                porArea: resumenPorArea
            };
        };



    const determinarColorOcupacion = (porcentaje) => {
        const p = parseFloat(porcentaje);
        if (p === 0) {
            return '#28a745';      // Verde: 0% (Disponible)
        } else if (p > 0 && p <= 50) {
            return '#17a2b8';      // Azul/Cian: 1% a 50% (Ocupaci√≥n Baja)
        } else if (p > 50 && p < 100) {
            return '#ffc107';      // Naranja/Amarillo: 51% a 99% (Ocupaci√≥n Media/Alta)
        } else if (p === 100) {
            return '#dc3545';      // Rojo: 100% (Lleno Total)
        }
        return '#555';             // Color por defecto
    };
    const mostrarModalOcupacion = (resumen) => {
        const modal = document.createElement('div');
        modal.classList.add('resumen-modal', 'ocupacion-modal');



        const totalMesasDisponibles = resumen.totalMesas - resumen.mesasOcupadas;
        const colorGlobal = determinarColorOcupacion(resumen.porcentajeGlobal); // <--- CAMBIO CLAVE AQU√ç
        // ----------------------------------------------------
        // CONSTRUCCI√ìN DEL ENCABEZADO GLOBAL (Bloque central grande)
        // ----------------------------------------------------
        const headerHTML = `
            <div class="global-summary-block">

                <div class="summary-item">
                    <span class="summary-value occupied-color">${resumen.mesasOcupadas}</span>
                    <span class="summary-label">Mesas Ocupadas</span>
                </div>

                <div class="summary-item total-mesas-gauge" 
                     data-percent="${resumen.porcentajeGlobal}" 
                     style="--p:${resumen.porcentajeGlobal}; --c:${colorGlobal};">
                    <span class="gauge-center-percent">${resumen.porcentajeGlobal}%</span>
                    <span class="gauge-center-label">Ocupaci√≥n Total</span>
                </div>

                <div class="summary-item">
                    <span class="summary-value libre-color">${totalMesasDisponibles}</span>
                    <span class="summary-label">Mesas Libres</span>
                </div>

            </div>
            <h3>Detalle de Ocupaci√≥n por √Årea:</h3>
            <div class="ocupacion-grid">
        `;

        // ----------------------------------------------------
        // CONSTRUCCI√ìN DEL DETALLE POR √ÅREA (Medidores peque√±os)
        // ----------------------------------------------------
        let detalleHTML = '';

        // Ordenar las √°reas por porcentaje de ocupaci√≥n (de mayor a menor)
        const areasOrdenadas = Object.keys(resumen.porArea)
            .map(nombre => ({ area: nombre, datos: resumen.porArea[nombre] }))
            .sort((a, b) => parseFloat(b.datos.porcentaje) - parseFloat(a.datos.porcentaje));

        areasOrdenadas.forEach(item => {
            const { area, datos } = item;
            // Colores para cada medidor: Rojo (lleno), Naranja (parcial), Verde (vac√≠o)
            const color = determinarColorOcupacion(datos.porcentaje); // <--- CAMBIO CLAVE AQU√ç
            const mesasDisponiblesArea = datos.total - datos.ocupadas;

            detalleHTML += `
                <div class="area-gauge-block">
                    <h4>${area}</h4>
                    <div class="area-gauge" 
                         data-percent="${datos.porcentaje}" 
                         style="--p:${datos.porcentaje}; --c:${color};">
                        <span class="gauge-percent-value">${datos.porcentaje}%</span>
                    </div>
                    <p class="gauge-info occupied-color">
                        Ocupadas: <strong>${datos.ocupadas}</strong>
                    </p>
                    <p class="gauge-info libre-color">
                        Libres: <strong>${mesasDisponiblesArea}</strong>
                    </p>
                    <p class="gauge-info">
                        Total: <strong>${datos.total}</strong>
                    </p>
                </div>
            `;
        });

        // Cierre del grid
        detalleHTML += '</div>';

        // Estructura final del Modal
        modal.innerHTML = `
            <div class="resumen-content">
                <div class="resumen-header">
                    <h2>üìà Porcentaje de Ocupaci√≥n</h2>
                    <button class="close-resumen">&times;</button>
                </div>

                <div class="resumen-body">
                    ${headerHTML}
                    ${detalleHTML}
                </div>

                <p class="nota">Basado en mesas con al menos una transacci√≥n registrada.</p>
            </div>
        `;

        document.body.appendChild(modal);
        // ‚úÖ BLOQUEAR SCROLL DEL BODY
        document.body.style.overflow = 'hidden';
        // L√≥gica para cerrar
        modal.querySelector('.close-resumen').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.style.overflow = ''; // Restaurar scroll
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                document.body.style.overflow = ''; // Restaurar scroll
            }
        });
    };
    /* =====================================================
        SCRIPT MEJORADO: CREAR IM√ÅGENES Y ASIGNAR EVENTO CLICK
        ===================================================== */

    document.querySelectorAll('.area-section').forEach(area => {
        const grid = area.querySelector('.image-grid');
        const img = grid.querySelector('img');
        const cantidad = parseInt(area.dataset.cantidad);
        // Obtener el nombre del √°rea de manera limpia (Ej: "Pacha", "Lounge")
        const areaName = area.querySelector("h2").textContent.replace("√Årea ", "").trim();

        grid.innerHTML = '';

        for (let i = 1; i <= cantidad; i++) {
            const clone = img.cloneNode(true);

            const wrapper = document.createElement('div');
            wrapper.classList.add('img-wrapper', 'mesa-link'); // Agregamos una clase para estilo/click

            // --- VERIFICAR SI LA MESA EST√Å OCUPADA ---
            const datosMesa = mesaData[areaName][i];
            let ocupada = false;

            if (datosMesa) {
                const monto1 = parseFloat(datosMesa.montos[0]) || 0;
                const monto2 = parseFloat(datosMesa.montos[1]) || 0;
                if (monto1 > 0 || monto2 > 0) {
                    ocupada = true;
                }
            }

            if (ocupada) {
                const ribbon = document.createElement("div");
                ribbon.classList.add("vendido-ribbon");
                ribbon.textContent = "VENDIDO";
                wrapper.appendChild(ribbon);
            }


            // Establecer el ID de la mesa para el evento de click
            wrapper.dataset.area = areaName;
            wrapper.dataset.mesa = i;

            wrapper.appendChild(clone);

            const numberBadge = document.createElement('div');
            numberBadge.classList.add('img-number');
            numberBadge.textContent = i;
            wrapper.appendChild(numberBadge);

            // 5. A√±adir el evento click
            wrapper.addEventListener('click', function() {
                const selectedArea = this.dataset.area;
                const selectedMesa = parseInt(this.dataset.mesa);
                mostrarComprobante(selectedArea, selectedMesa);
            });

            grid.appendChild(wrapper);
        }
    });

}); 
// ===================================
// ACCORDION
// ===================================
function setupAccordionLogic() {
    const headers = document.querySelectorAll('.accordion-header');

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);
            const icon = header.querySelector('.toggle-icon');

            if (!content) return;

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                if (icon) icon.textContent = '+';
            } else {
                content.style.maxHeight = "3000px";
                if (icon) icon.textContent = '‚Äì';
            }
        });
    });
}

function renderReporte(data, rIndex) {

    const mainContentId = `main-report-content-${rIndex}`;
    const reportContainerId = `reporte-container-${rIndex}`; 

    // --- Preparaci√≥n de datos (Robusto contra valores nulos/faltantes) ---
    const s = data.saldoFinal;

    // Aseguramos que los valores sean n√∫meros, por si faltan en el JSON, evitar NaN.
    const ingresado = s.ingresado || 0;
    const transferenciasEnviadas = s.transferenciasEnviadas || 0;
    const transferenciasRecibidas = s.transferenciasRecibidas || 0;

    // Generamos la f√≥rmula usando los valores limpios
    const formula = `${ingresado.toLocaleString('es-BO')} - ${transferenciasEnviadas.toLocaleString('es-BO')} + ${transferenciasRecibidas.toLocaleString('es-BO')}`;

    let html = `
        <div id="${reportContainerId}" class="reporte-printable-area">¬†
            <h2>${data.resumen.titulo}</h2>

            <div class="ticket-section accordion-item main-report-accordion">
            <h3 class="accordion-header main-header" data-target="${mainContentId}">
                Reporte ${data.fecha}
                <span class="toggle-icon">+</span>
            </h3>

            <div id="${mainContentId}" class="accordion-content">
    `;
    // ================= CUENTAS =================
    data.cuentas
      .filter(cuenta => cuenta.transacciones > 0 && cuenta.total > 0)
      .forEach((cuenta, cIndex) => {

        const contentId = `details-${rIndex}-${cIndex}`;

        html += `
          <div class="inner-accordion-item">
            <h4 class="accordion-header inner-header" data-target="${contentId}">
              Cuenta: ${cuenta.nombre} (${cuenta.transacciones} transacciones)
              <span class="toggle-icon">+</span>
            </h4>

            <div id="${contentId}" class="accordion-content">
              <p><strong>Total: Bs. ${cuenta.total.toLocaleString('es-BO')}</strong></p>

              <ul class="ticket-grid-list">
                ${cuenta.detalles.map(d => `
                  <li>
                    <span class="mesa">${d.mesa}</span>
                    <span class="monto">Bs. ${d.monto.toLocaleString('es-BO')}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
        `;
    });


    // ================= TRANSFERENCIAS (Robusto: solo muestra si hay datos) =================

    // Verificamos que el objeto de transferencias exista
    if (data.transferencias) {
        ['mama', 'pacha'].forEach(tipo => {

            const transferenciaData = data.transferencias[tipo];

            // Verificamos si hay detalles Y si el total transferido es mayor que cero
            if (transferenciaData?.detalles?.length && transferenciaData.totalTransferido > 0) {

                const transferId = `transfer-${tipo}-${rIndex}`;
                const total = transferenciaData.totalTransferido;

                html += `
                    <div class="ticket-section transfer inner-section accordion-item">
                        <h4 class="accordion-header inner-header" data-target="${transferId}">
                            ${transferenciaData.descripcion || `Transferencias a ${tipo.toUpperCase()}`}
                            <span class="toggle-icon">+</span>
                        </h4>

                        <div id="${transferId}" class="accordion-content">
                            <p class="total-transfer">
                                Total a transferir:
                                <strong>Bs. ${total.toLocaleString('es-BO')}</strong>
                            </p>

                          <ul class="ticket-simple-list">
                          ${transferenciaData.detalles.map(t => {
                                const detalleTexto = `(${t.porcentaje}% de Bs. ${t.montoOriginal.toLocaleString('es-BO')})`;
                                // Dentro de tu renderReporte, en la parte de transferencias:
                                return `
                                <li class="transfer-item">
                                    <div class="transfer-left">
                                        <span class="transfer-mesa">${t.mesa}</span>
                                        <span class="transfer-detalle">${t.porcentaje}% de Bs. ${t.montoOriginal.toLocaleString('es-BO')}</span>
                                    </div>
                                    <div class="transfer-right">
                                        <span class="transfer-label">Transferir:</span>
                                        <span class="transfer-monto">Bs. ${t.transferencia.toLocaleString('es-BO')}</span>
                                    </div>
                                </li>
                                `;
                            }).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }
        });
    }

    // ================= SALDO FINAL (CON F√ìRMULA) =================
    const finalId = `final-saldo-${rIndex}`;

    html += `
        <div class="ticket-section final inner-section accordion-item">
            <h4 class="accordion-header inner-header" data-target="${finalId}">
                ${s.descripcion || 'Cierre de Caja / Saldo Final'}
                <span class="toggle-icon">+</span>
            </h4>

            <div id="${finalId}" class="accordion-content">
                <div class="fila-saldo">
                    <span class="label-text">Total Ingresado:</span>
                    <strong class="amount">Bs. ${ingresado.toLocaleString('es-BO')}</strong>
                </div>
                <div class="fila-saldo">
                    <span class="label-text">Trans. realizadas a Mama:</span>
                    <span class="amount">Bs. ${transferenciasEnviadas.toLocaleString('es-BO')}</span>
                </div>
                <div class="fila-saldo">
                    <span class="label-text">Trans. recibidas de Mama:</span>
                    <span class="amount">Bs. ${transferenciasRecibidas.toLocaleString('es-BO')}</span>
                </div>

                <hr>
                <p class="formula-container"><strong>C√°lculo:</strong> <span class="formula">${formula}</span></p>
                <hr>

                <div class="saldo-destacado">
                    <p><strong>SALDO ACTUAL EN BANCO</strong></p>
                    <p class="monto-final">Bs. ${s.saldo.toLocaleString('es-BO')}</p>
                </div>

                <div class="banco-detalles">
                    <p>Banco: <span>${s.banco}</span></p>
                    <p>N¬∞ Cuenta: <span>${s.cuenta}</span></p>
                    <p>Referencia: <span>${s.referencia}</span></p>
                    <p class="nota-final">${s.nota || ''}</p>
                </div>
            </div>
        </div>
    </div> 
</div>
    `;

    return html;
}

function renderReportes(data) {
    // üí° CORRECCI√ìN PRINCIPAL: Usar .flat() para manejar el array anidado en el JSON
    const reportesAplanados = data.reportes.flat();¬†
    let html = '';
    let ultimoAnio = null;

    reportesAplanados.forEach((reporte, index) => {

        const anioActual = reporte.fecha.split('-')[2]; // "25", "26"

        // Si el a√±o cambia, insertamos un separador visual
        if (ultimoAnio !== null && anioActual !== ultimoAnio) {
            html += `
                <div class="separador-anio">
                    <span>A√ëO 20${anioActual}</span>
                </div>
            `;
        }

        ultimoAnio = anioActual;


        // üîí Filtro para no mostrar si el array de cuentas no existe o est√° vac√≠o
        if (!reporte.cuentas || reporte.cuentas.length === 0) {
            return;
        }

        // üîí Filtro adicional: No mostrar si el total de todas las cuentas es 0
        const tieneIngresos = reporte.cuentas.some(c => c.total > 0);
        if (!tieneIngresos) {
            return;
        }

        html += renderReporte(reporte, index);
    });

    // Si no hay ning√∫n reporte con datos (despu√©s del filtrado)
    if (!html) {
        contenidoReportes.innerHTML = `
            <p style="padding:20px; text-align:center; color:#aaa;">
                No hay reportes con datos todav√≠a
            </p>
        `;
        return;
    }

    contenidoReportes.innerHTML = html;
    setupAccordionLogic();
}

// ‚ùå ELIMINADA: La funci√≥n imprimirReporte ya no es necesaria.

// ===================================
// MODAL + FETCH
// ===================================
const btnReportes = document.getElementById("btn-reportes");
const modalReportes = document.getElementById("modal-reportes");
const contenidoReportes = document.getElementById("contenido-reportes");
const cerrarModalReportes = document.querySelector(".close-modal");

btnReportes.addEventListener("click", async (e) => {
    e.preventDefault();

    modalReportes.style.display = "block";
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    try {
        const response = await fetch("reportes.json");
        const data = await response.json();
        renderReportes(data);
    } catch (error) {
        contenidoReportes.innerHTML = `
            <p style="color:red; padding:20px;">
                Error cargando reportes: ${error.message}
            </p>`;
    }
});

cerrarModalReportes.addEventListener("click", () => {
    modalReportes.style.display = "none";
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
});

modalReportes.addEventListener("click", (e) => {
    if (e.target === modalReportes) {
        modalReportes.style.display = "none";
        document.documentElement.style.overflow = "";
        document.body.style.overflow = "";
    }
});
